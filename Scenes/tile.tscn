[gd_scene load_steps=7 format=2]

[ext_resource path="res://Sprite/Earth/earth_dry.png" type="Texture" id=1]
[ext_resource path="res://Sprite/Earth/earth_normal.png" type="Texture" id=2]
[ext_resource path="res://Sprite/Earth/earth_wet.png" type="Texture" id=3]
[ext_resource path="res://Sprite/Corn/corn_stage6.png" type="Texture" id=4]

[sub_resource type="GDScript" id=1]
script/source = "extends Node2D

const max_wetness = 300
const wetness_normal = 200
const wetness_dry = 100

var wetness

var dry_speed = 0.2

var growth_stage = 0
const growth_stage_max = 6

var growth_counter;
var growth_base = 300;
var growth_rand = 200;

var gfx_corn_1 = preload(\"res://Sprite/Corn/corn_stage1.png\")
var gfx_corn_2 = preload(\"res://Sprite/Corn/corn_stage2.png\")
var gfx_corn_3 = preload(\"res://Sprite/Corn/corn_stage3.png\")
var gfx_corn_4 = preload(\"res://Sprite/Corn/corn_stage4.png\")
var gfx_corn_5 = preload(\"res://Sprite/Corn/corn_stage5.png\")
var gfx_corn_6 = preload(\"res://Sprite/Corn/corn_stage6.png\")

func _schedule_next_stage():
	
	if growth_stage > 0 and growth_stage < growth_stage_max:
		growth_counter = growth_base + randi() % growth_rand
	else:
		growth_counter = 0

# Called when the node enters the scene tree for the first time.
func _ready():

	wetness = max_wetness
	
	growth_stage = randi() % growth_stage_max
	
	_schedule_next_stage()
	_update_sprite()

func _update_sprite():
	
	$earth_dry.visible = false
	$earth_normal.visible = false
	$earth_wet.visible = false
	
	if wetness < wetness_dry:
		$earth_dry.visible = true
	elif wetness < wetness_normal:
		$earth_normal.visible = true
	else:
		$earth_wet.visible = true
		
	if growth_stage == 0:
		$Corn.visible = false
	else:
		match growth_stage:
			1: $Corn.texture = gfx_corn_1
			2: $Corn.texture = gfx_corn_2
			3: $Corn.texture = gfx_corn_3
			4: $Corn.texture = gfx_corn_4
			5: $Corn.texture = gfx_corn_5
			6: $Corn.texture = gfx_corn_6
		$Corn.visible = true

func _physics_process(delta):
	
	var updated:bool = false
	
	if wetness > 0:
		
		if randf() <= dry_speed:
			wetness -= 1
			updated = true
			
	if growth_counter > 0:
		
		growth_counter -= 1;
		
		if growth_counter == 0:
			growth_stage += 1
			_schedule_next_stage()
			updated = true
			
	if updated:
		_update_sprite()


func _on_Collision_input_event(viewport, event, shape_idx):
	if event is InputEventMouseButton:
		print('mouse button')
		if event.pressed and event.button_index == 0:
			print('left click')
"

[sub_resource type="RectangleShape2D" id=2]
extents = Vector2( 63.609, 64.0676 )

[node name="Tile" type="Node2D"]
script = SubResource( 1 )

[node name="earth_wet" type="Sprite" parent="."]
visible = false
texture = ExtResource( 3 )

[node name="earth_normal" type="Sprite" parent="."]
texture = ExtResource( 2 )

[node name="earth_dry" type="Sprite" parent="."]
visible = false
texture = ExtResource( 1 )

[node name="Corn" type="Sprite" parent="."]
position = Vector2( 0, -85.6192 )
scale = Vector2( 1.1, 1.1 )
texture = ExtResource( 4 )

[node name="Collision" type="StaticBody2D" parent="."]
input_pickable = true

[node name="CollisionShape2D" type="CollisionShape2D" parent="Collision"]
shape = SubResource( 2 )
[connection signal="input_event" from="Collision" to="." method="_on_Collision_input_event"]
